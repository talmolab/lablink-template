# LabLink Allocator Configuration
# This file configures the allocator service and client VM specifications
# Copy to config.yaml and customize for your deployment
# Note: This config is validated in CI using lablink-validate-config

db:
  dbname: "lablink_db"
  user: "lablink"
  password: "PLACEHOLDER_DB_PASSWORD"  # Injected from GitHub secret at deploy time
  host: "localhost"
  port: 5432
  table_name: "vms"
  message_channel: "vm_updates"

machine:
  # Client VM instance type (must support your workload)
  machine_type: "g4dn.xlarge"  # GPU instance for ML workloads

  # Docker image for client VMs (use version tags for production)
  image: "ghcr.io/talmolab/lablink-client-base-image:linux-amd64-0d73aef91a90afe5289b2252fcde76aa1fd4e31f-test"

  # AMI ID for your AWS region (Ubuntu 24.04 with Docker + Nvidia GPU Driver)
  ami_id: "ami-0601752c11b394251"  # us-west-2 Ubuntu 24.04 custom AMI

  # Git repository with your data/code (optional - leave empty if not needed)
  repository: "https://github.com/talmolab/sleap-tutorial-data.git"

  # Software identifier for your application
  software: "sleap"

  # File extension for your data files
  extension: "slp"

# Allocator service configuration
allocator:
  # Docker image tag for the allocator service
  # For test: use "linux-amd64-latest-test"
  # For prod: use specific version like "linux-amd64-v1.2.3"
  image_tag: "linux-amd64-0d73aef91a90afe5289b2252fcde76aa1fd4e31f-test"

app:
  admin_user: "admin"
  admin_password: "PLACEHOLDER_ADMIN_PASSWORD"  # Injected from GitHub secret at deploy time
  region: "us-west-2"  # Your AWS region

dns:
  enabled: true  # true = use DNS for allocator URL, false = IP-only access
  terraform_managed: true  # false = manual DNS records (you create in Route53), true = Terraform creates/destroys records
  domain: "ci-test.lablink-template-testing.com"  # Full domain name for the allocator (supports sub-subdomains)
  zone_id: "Z1038183268T83E91AYJF"  # (Optional) Hardcode zone ID to skip lookup - leave empty for auto-lookup

eip:
  # EIP name is derived from deployment_name: {deployment_name}-eip-{environment}
  strategy: "persistent"  # "persistent" = reuse existing EIP with matching name tag, "dynamic" = create new EIP each deployment

ssl:
  provider: "letsencrypt"  # "letsencrypt" = Caddy auto-SSL, "cloudflare" = CloudFlare proxy, "acm" = AWS Certificate Manager, "none" = HTTP only
  email: "berri104@gmail.com"  # Email for Let's Encrypt notifications
  certificate_arn: ""  # Required when provider="acm" - ARN of ACM certificate

startup_script:
  enabled: true # true = run custom startup script on client VMs, false = no script
  path: "config/custom-startup.sh"  # Path to custom startup script (optional)
  on_error: "continue"  # "continue" = ignore errors, "fail" = stop VM setup on error

# Monitoring and alerting configuration
monitoring:
  enabled: true  # Enable CloudWatch alarms and SNS notifications
  email: "admin@example.com"  # Email for budget alerts and CloudWatch alarms

  budget:
    enabled: false  # Enable AWS Budget alerts (requires monitoring.email)
    monthly_budget_usd: "100"  # Monthly budget limit in USD

  thresholds:
    max_instances_per_5min: 10  # Alert if more than N instances launched in 5 min
    max_unauthorized_calls_per_15min: 5  # Alert on unauthorized API calls
    max_terminations_per_5min: 10  # Alert on mass instance terminations

  cloudtrail:
    retention_days: 90  # CloudTrail log retention in days

# S3 bucket for Terraform state (must be unique globally)
# Only used for test/prod environments with S3 backend (not used in dev)
# Template testing uses separate bucket from production deployments
bucket_name: "tf-state-lablink-template-testing"
