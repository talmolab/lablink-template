# LabLink CI-Test Configuration
# For template maintainers testing infrastructure changes
# This configuration is for validating the template itself works correctly
#
# ⚠️ IMPORTANT - Template Maintainers Only:
# - This config uses Let's Encrypt with a shared domain: ci-test.lablink-template-testing.com
# - RATE LIMIT: 5 deployments per week maximum (Let's Encrypt limit)
# - Coordinate with team before deploying to avoid hitting limit
# - Consider using IP-only for some infrastructure tests
# - Monitor usage: https://crt.sh/?q=lablink-template-testing.com
#
# Prerequisites:
# - Access to talmolab AWS account
# - GitHub secrets configured for ci-test environment
# - Coordinate with team to avoid simultaneous deploys
#
# Usage:
#   # Template maintainers only - tests the template repo infrastructure
#   cp lablink-infrastructure/config/ci-test.example.yaml lablink-infrastructure/config/config.yaml
#   # Edit config.yaml if needed (usually pre-configured)
#   ./scripts/setup-aws-infrastructure.sh  # Creates template testing infrastructure
#   cd lablink-infrastructure
#   ../scripts/init-terraform.sh ci-test
#   terraform apply -var="resource_suffix=ci-test"
#
# Access URL: https://ci-test.lablink-template-testing.com
#
# Note: This uses separate AWS infrastructure from production deployments
# to avoid conflicts when testing template changes.

db:
  dbname: "lablink_db"
  user: "lablink"
  password: "PLACEHOLDER_DB_PASSWORD"  # Injected from GitHub secret at deploy time
  host: "localhost"
  port: 5432
  table_name: "vms"
  message_channel: "vm_updates"

machine:
  # Client VM instance type (can use smaller for testing)
  machine_type: "t3.medium"  # Cheaper for template testing

  # Docker image for client VMs
  image: "ghcr.io/talmolab/lablink-client-base-image:linux-amd64-latest-test"

  # AMI ID for your AWS region (Ubuntu 24.04 with Docker + Nvidia GPU Driver)
  ami_id: "ami-0601752c11b394251"  # us-west-2 Ubuntu 24.04 custom AMI

  # Git repository with test/tutorial data
  repository: "https://github.com/talmolab/sleap-tutorial-data.git"

  # Software identifier
  software: "sleap"

  # File extension
  extension: "slp"

# Allocator service configuration
allocator:
  # Use latest test image for CI testing
  image_tag: "linux-amd64-latest-test"

app:
  admin_user: "admin"
  admin_password: "PLACEHOLDER_ADMIN_PASSWORD"  # Injected from GitHub secret at deploy time
  region: "us-west-2"

dns:
  # DNS enabled for testing
  enabled: true
  terraform_managed: true  # Let Terraform manage DNS records
  domain: "ci-test.lablink-template-testing.com"  # Full domain name
  zone_id: "Z1038183268T83E91AYJF"  # Template testing zone

eip:
  # Use persistent EIP for ci-test
  strategy: "persistent"
  tag_name: "lablink-eip"  # Will become lablink-eip-ci-test

ssl:
  # Use Let's Encrypt for testing (production certs)
  provider: "letsencrypt"
  email: "berri104@gmail.com"
  certificate_arn: ""

startup_script:
  enabled: false
  path: "config/custom-startup.sh"
  on_error: "continue"

# S3 bucket for Terraform state (template testing infrastructure)
# Separate from production deployments to avoid conflicts
bucket_name: "tf-state-lablink-template-testing"
